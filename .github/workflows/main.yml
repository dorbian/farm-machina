name: Sync upstream honse-farm & Build Dockerfiles into GHCR (multi-arch)

on:
  schedule:
    - cron: "0 * * * *"   # hourly; tweak as needed
  workflow_dispatch:

permissions:
  contents: read
  packages: write   # needed to push to GHCR

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  detect-and-prepare:
    name: Detect upstream change & prepare matrix
    runs-on: ubuntu-latest

    outputs:
      changed: ${{ steps.check.outputs.changed }}
      upstream_commit: ${{ steps.upstream.outputs.latest_commit }}
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          set -euo pipefail
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse

      - name: Determine latest upstream commit (dev branch)
        id: upstream
        run: |
          set -euo pipefail
          cd upstream-honse
          git checkout dev
          COMMIT=$(git rev-parse HEAD)
          echo "Latest upstream dev commit: $COMMIT"
          echo "latest_commit=$COMMIT" >> "$GITHUB_OUTPUT"

      - name: Cache last processed commit
        id: cache
        uses: actions/cache@v4
        with:
          path: .upstream-cache
          key: upstream-dev-${{ steps.upstream.outputs.latest_commit }}

      - name: Check if repo changed
        id: check
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "No upstream updates on dev."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Upstream dev updated."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build Dockerfile matrix
        id: matrix
        if: steps.check.outputs.changed == 'true'
        run: |
          set -euo pipefail
          cd upstream-honse

          # Find Dockerfiles AND Dockerfile.* variants
          FILES=$(find . -type f \( -name 'Dockerfile' -o -name 'Dockerfile.*' \) | sed 's|^\./||')

          if [ -z "$FILES" ]; then
            echo "No Dockerfiles found."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Dockerfiles found:"
          echo "$FILES"

          # Build compact JSON matrix: include[{path, name, platforms}]
          # - path: relative path to Dockerfile
          # - name: directory of Dockerfile â†’ safe, lowercase image name suffix
          # - platforms:
          #     * default: linux/amd64,linux/arm64
          #     * adminpanel: linux/amd64 only
          MATRIX=$(echo "$FILES" | jq -R -s '
            split("\n")
            | map(select(length>0))
            | map({
                path: .,
                raw_name: ( . 
                            | sub("/Dockerfile(\\..*)?$";"") 
                            | gsub("[^a-zA-Z0-9._-]"; "-") 
                            | if . == "" then "root" else . end ),
                platforms: ( if contains("HonseFarm.Adminpanel") 
                             then "linux/amd64"
                             else "linux/amd64,linux/arm64"
                           end )
              })
            | map({
                path: .path,
                name: (.raw_name | ascii_downcase),
                platforms: .platforms
              })
          ' | jq -c '.')

          echo "matrix={\"include\":${MATRIX}}" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build & push all Dockerfiles to GHCR
    needs: detect-and-prepare
    runs-on: ubuntu-latest
    if: needs.detect-and-prepare.outputs.changed == 'true'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-and-prepare.outputs.matrix) }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          set -euo pipefail
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse
          cd upstream-honse
          git checkout dev

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
            -u "${{ github.actor }}" --password-stdin

      - name: Build & push image for ${{ matrix.name }}
        env:
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          set -euo pipefail

          COMMIT="${{ needs.detect-and-prepare.outputs.upstream_commit }}"
          TAG="${COMMIT::7}"

          DOCKERFILE="upstream-honse/${{ matrix.path }}"
          CONTEXT="upstream-honse"
          PLATFORMS="${{ matrix.platforms }}"

          # image repo: ghcr.io/<owner>/honse-<name>
          IMAGE_REPO="${REGISTRY}/honse-${{ matrix.name }}"
          IMAGE_TAG="${IMAGE_REPO}:${TAG}"
          IMAGE_DEV="${IMAGE_REPO}:dev-latest"

          echo "Building for Dockerfile: $DOCKERFILE"
          echo "Context (repo root): $CONTEXT"
          echo "Platforms: $PLATFORMS"
          echo "Image (tagged): ${IMAGE_TAG} and ${IMAGE_DEV}"

          # Build and push multi-arch image directly to GHCR
          docker buildx build \
            --platform "$PLATFORMS" \
            --file "$DOCKERFILE" \
            --tag "$IMAGE_TAG" \
            --tag "$IMAGE_DEV" \
            --push \
            "$CONTEXT"
