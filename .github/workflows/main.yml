name: Sync upstream honse-farm & Build Dockerfiles (multi-arch)

on:
  schedule:
    - cron: "0 * * * *"   # hourly
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-and-prepare:
    name: Detect upstream change & prepare matrix
    runs-on: ubuntu-latest

    outputs:
      changed: ${{ steps.check.outputs.changed }}
      upstream_commit: ${{ steps.upstream.outputs.latest_commit }}
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse

      - name: Determine latest upstream commit
        id: upstream
        run: |
          cd upstream-honse
          git checkout main
          COMMIT=$(git rev-parse HEAD)
          echo "Latest upstream commit: $COMMIT"
          echo "latest_commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Cache last processed commit
        id: cache
        uses: actions/cache@v4
        with:
          path: .upstream-cache
          key: upstream-${{ steps.upstream.outputs.latest_commit }}

      - name: Check if repo changed
        id: check
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "No upstream updates."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Upstream updated."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build Dockerfile matrix
        id: matrix
        if: steps.check.outputs.changed == 'true'
        run: |
          cd upstream-honse

          # Find Dockerfiles
          FILES=$(find . -type f -name Dockerfile | sed 's|^\./||')

          if [ -z "$FILES" ]; then
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Dockerfiles found:"
          echo "$FILES"

          MATRIX=$(echo "$FILES" | jq -R -s '
            split("\n") | map(select(length > 0))
            | map({
                path: .,
                context: ( . | sub("/Dockerfile$";"") | if . == "" then "." else . end ),
                name: ( . | sub("/Dockerfile$";"") | gsub("[^a-zA-Z0-9._-]"; "-") | if . == "" then "root" else . end )
            })
          ')

          echo "matrix={\"include\":${MATRIX}}" >> $GITHUB_OUTPUT

  build-images:
    name: Build all Dockerfiles (amd64+arm64)
    needs: detect-and-prepare
    runs-on: ubuntu-latest
    if: needs.detect-and-prepare.outputs.changed == 'true'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-and-prepare.outputs.matrix) }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build multi-arch image for ${{ matrix.name }}
        run: |
          COMMIT="${{ needs.detect-and-prepare.outputs.upstream_commit }}"
          TAG="${COMMIT::7}"

          DOCKERFILE="upstream-honse/${{ matrix.path }}"
          CONTEXT="upstream-honse/${{ matrix.context }}"

          mkdir -p artifacts
          OUTPUT="artifacts/${{ matrix.name }}-${TAG}.oci.tar"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file "$DOCKERFILE" \
            --output "type=oci,dest=${OUTPUT}" \
            "$CONTEXT"

          echo "Built image saved as ${OUTPUT}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: honse-images-${{ needs.detect-and-prepare.outputs.upstream_commit }}
          path: artifacts/
