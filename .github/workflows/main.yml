name: Sync upstream honse-farm & Build Dockerfiles (multi-arch)

on:
  schedule:
    - cron: "0 * * * *"   # hourly, tweak as needed
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-and-prepare:
    name: Detect upstream change & prepare matrix
    runs-on: ubuntu-latest

    outputs:
      changed: ${{ steps.check.outputs.changed }}
      upstream_commit: ${{ steps.upstream.outputs.latest_commit }}
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          set -euo pipefail
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse

      - name: Determine latest upstream commit (dev branch)
        id: upstream
        run: |
          set -euo pipefail
          cd upstream-honse
          git checkout dev
          COMMIT=$(git rev-parse HEAD)
          echo "Latest upstream dev commit: $COMMIT"
          echo "latest_commit=$COMMIT" >> "$GITHUB_OUTPUT"

      - name: Cache last processed commit
        id: cache
        uses: actions/cache@v4
        with:
          path: .upstream-cache
          key: upstream-dev-${{ steps.upstream.outputs.latest_commit }}

      - name: Check if repo changed
        id: check
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "No upstream updates on dev."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Upstream dev updated."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build Dockerfile matrix
        id: matrix
        if: steps.check.outputs.changed == 'true'
        run: |
          set -euo pipefail
          cd upstream-honse

          # Find Dockerfiles AND Dockerfile.* variants
          FILES=$(find . -type f \( -name 'Dockerfile' -o -name 'Dockerfile.*' \) | sed 's|^\./||')

          if [ -z "$FILES" ]; then
            echo "No Dockerfiles found."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Dockerfiles found:"
          echo "$FILES"

          # Build compact JSON matrix: include[{path, name, platforms}]
          # - path: relative path to Dockerfile
          # - name: directory of Dockerfile â†’ safe image name
          # - platforms:
          #     * default: linux/amd64,linux/arm64
          #     * adminpanel: linux/amd64 only (to avoid QEMU+Node illegal instruction)
          MATRIX=$(echo "$FILES" | jq -R -s '
            split("\n")
            | map(select(length>0))
            | map({
                path: .,
                name: ( . 
                        | sub("/Dockerfile(\\..*)?$";"") 
                        | gsub("[^a-zA-Z0-9._-]"; "-") 
                        | if . == "" then "root" else . end ),
                platforms: ( if contains("HonseFarm.Adminpanel") 
                             then "linux/amd64"
                             else "linux/amd64,linux/arm64"
                           end )
              })
          ' | jq -c '.')

          echo "matrix={\"include\":${MATRIX}}" >> "$GITHUB_OUTPUT"

  build-images:
    name: Build all Dockerfiles (multi-arch per matrix)
    needs: detect-and-prepare
    runs-on: ubuntu-latest
    if: needs.detect-and-prepare.outputs.changed == 'true'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-and-prepare.outputs.matrix) }}

    steps:
      - name: Clone upstream honse-farm repo
        run: |
          set -euo pipefail
          git clone https://git.honse.farm/astraea/honse-farm.git upstream-honse
          cd upstream-honse
          git checkout dev

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build multi-arch image for ${{ matrix.name }}
        run: |
          set -euo pipefail

          COMMIT="${{ needs.detect-and-prepare.outputs.upstream_commit }}"
          TAG="${COMMIT::7}"

          DOCKERFILE="upstream-honse/${{ matrix.path }}"
          CONTEXT="upstream-honse"
          PLATFORMS="${{ matrix.platforms }}"

          echo "Building for Dockerfile: $DOCKERFILE"
          echo "Context (repo root): $CONTEXT"
          echo "Platforms: $PLATFORMS"

          mkdir -p artifacts
          OUTPUT="artifacts/${{ matrix.name }}-${TAG}.oci.tar"

          docker buildx build \
            --platform "$PLATFORMS" \
            --file "$DOCKERFILE" \
            --output "type=oci,dest=${OUTPUT}" \
            "$CONTEXT"

          echo "Built image saved as ${OUTPUT}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          # unique per dockerfile to avoid 409 conflicts
          name: honse-image-${{ matrix.name }}-${{ needs.detect-and-prepare.outputs.upstream_commit }}
          path: artifacts/
